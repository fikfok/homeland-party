{% extends "base.html" %}
{% load static %}

{% block styles %}
    <style>
        .yandex-map {
            width: {{ map_width }}px;
            height: {{ map_height }}px;
        }
    </style>
{% endblock styles %}

{% block scripts_head %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
{% endblock scripts_head %}

{% block container %}
    <div id="content">
        {% block content %}
            <h1>Вступить в географиескую десятку</h1>
            {% if geo %}

                <dev class="row">
                    <dev class="col">
                        {% if geo_tens_for_join_qs %}

                            <div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" id="geoTenMapModal" aria-labelledby="geoTenMapLabel" aria-hidden="true">
                                <div class="modal-dialog _modal-sm" role="document">
                                    <div class="modal-content">
                                        <div id="geoTenMapModalHeader" class="modal-header text-center">
                                            <h4 class="modal-title font-weight-bold">Географическая десятка на карте</h4>
                                            <button type="button" id="geoTenMapClose" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <div id="modalMessage">
                                                <div id="map" class="yandex-map"></div>
                                            </div>
                                        </div>
                                        <div class="modal-footer d-flex justify-content-center">
                                            <button type="button" class="btn btn-primary" id="geoTenMapOk">OK</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p>Вы можете вступить в одну из следующих географических десяток:</p>
                            <table class="table">
                              <thead>
                                <tr>
                                  <th scope="col">#</th>
                                  <th scope="col">Адрес</th>
                                  <th scope="col">Кол-во участников</th>
                                  <th scope="col">Посмотреть место на карте</th>
                                  <th scope="col"></th>
                                </tr>
                              </thead>
                              <tbody>
                                  {% for geo_ten in geo_tens_for_join_qs %}
                                      <tr>
                                          <th scope="row">{{ forloop.counter }}</th>
                                          <td>{{ geo_ten.get_geo }}</td>
                                          <td><p class="text-center">{{ geo_ten.participants_count }}</p></td>
                                          <td>
                                              <p class="text-center">
                                                  <span class="text-success geoMark" role="button" data-geocode="{{ geo_ten.get_geo.geo_lat }},{{ geo_ten.get_geo.geo_lon }}">
                                                      <i class="fa fa-2x fa-map-marker-alt"></i>
                                                  </span>
                                              </p>
                                          </td>
                                          <td><button type="button" class="btn btn-primary join-ten">Подать заявку</button></td>
                                      </tr>
                                  {% endfor %}

                              </tbody>
                            </table>
                        {% else %}
                            <p>Пока не создано ни одной географической десятки.</p>
                            {%  if user_can_create_geo_community %}
                                <p>Вы можете сами <a href="{% url 'veche:geo_ten' %}">создать географическую десятку</a>.</p>
                            {% endif %}
                        {% endif %}
                    </dev>
                </dev>

            {% else %}
                <p>Вы не указали своё местоположение. Перейдите, пожалуйста, на <a href="{% url 'personal_cabinet:profile' %}">страницу профиля</a> и
                укажите своё геограгфическое положение.</p>
            {% endif %}
        {% endblock %}
    </div>
{% endblock container %}


{% block scripts %}
    <script>
        {% if geo_tens_for_join_qs %}
            var myMap, currentPlacemark;

            $('#geoTenMapModal').on('hidden.bs.modal', function () {
                $('#map').empty()
            });

            $('#geoTenMapClose').on('click', function(event) {
                $('#geoTenMapModal').modal('hide');
            });
            $('#geoTenMapOk').on('click', function(event) {
                $('#geoTenMapModal').modal('hide');
            });

            $(".geoMark").click(function(ev) {
                var cords = $(ev.currentTarget).data('geocode').split(',');

                ymaps.ready(init);
                function init() {
                    myMap = new ymaps.Map('map', {
                        center: cords,
                        zoom: 7
                    });
                    myMap.geoObjects.removeAll();
                    currentPlacemark = new ymaps.Placemark();
                    currentPlacemark.geometry.setCoordinates(cords);
                    myMap.geoObjects.add(currentPlacemark);
                }

                $('#geoTenMapModal').modal('show');
            });
        {% endif %}
    </script>
{% endblock scripts %}